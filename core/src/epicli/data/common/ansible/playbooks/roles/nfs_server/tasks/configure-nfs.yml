---
- name: Generate /etc/exports file
  template:
    src: etc-exports.j2
    dest: /etc/exports
    owner: root
    group: root
    mode: 0644
    backup: yes

- name: Ensure NFS directories exist
  file:
    path: "{{ item.shared_directory }}"
    state: directory
  loop: "{{ specification.nfs_exports }}"

- name: Ensure NFS mounts are bound
  mount:
    path: "{{ item.export_directory }}"
    src: "{{ item.shared_directory }}"
    opts: bind
    state: mounted
    fstype: none
  loop: "{{ specification.nfs_exports }}"

- name: Ensure NFS is running
  systemd:
    name: "{{ nfs_service_name[ansible_os_family] }}"
    state: started
    enabled: yes

- name: Export all entries from /etc/exports
  command: exportfs -ra
