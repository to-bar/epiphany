---
- name: Set firewall facts
  include_tasks: firewall/set-common-vars.yml

- name: Check if {{ repo_firewall_rule_added_flag_file }} file exists
  stat:
    path: "{{ repo_firewall_rule_added_flag_file }}"
  register: repo_firewall_rule_added_flag_file_stat

# Note: Current zone when run 'teardown' may be different than was while 'setup'

- name: Get firewall Epiphany configuration
  block:
    - name: Include vars from firewall role
      include_vars:
        file: roles/firewall/vars/main.yml
        name: firewall_role_config

    - name: Get firewall settings from Epiphany configuration
      set_fact:
        firewall_config_applied: "{{ firewall_role_config.specification.firewall_enabled }}"
        managed_zone: "{{ firewall_role_config.specification.managed_zone_name }}"
  when:
    - "'firewall' in group_names"
    - "'firewall' in epiphany_enabled_roles" # to not fail if firewall role is disabled

- name: Remove temporary firewall rule for epirepo added by repository role
  block:
    - name: Get name of modified zone from file
      set_fact:
        modified_zone: "{{ lookup('file', modified_zone_name_file) }}"

    - name: Restore configuration of {{ modified_zone | default('modified') }} zone from backup
      copy:
        src: "{{ zone_config_backup_dest_dir }}/{{ modified_zone }}.xml.bak"
        dest: /etc/firewalld/zones/{{ modified_zone }}.xml
        remote_src: yes
        mode: preserve
      register: restore_modified_zone_from_backup
      when:
        - firewall_config_applied is undefined
          or not firewall_config_applied
          or managed_zone != modified_zone # to not overwrite configuration applied by firewall role

    - name: Clean up temporary firewall files
      file:
        path: "{{ item }}"
        state: absent
      loop: [ repo_firewall_rule_added_flag_file, modified_zone_name_file, "{{ zone_config_backup_dest_dir }}/{{ modified_zone }}.xml.bak" ]
  when:
    - repo_firewall_rule_added_flag_file_stat.stat.exists

- name: Remove temporary firewall rule for epirepo added by firewall role
  blockinfile:
    path: /etc/firewalld/zones/{{ managed_zone }}.xml
    marker_begin: BEGIN
    marker_end: END
    marker: <!-- {mark} ANSIBLE MANAGED TEMPORARY BLOCK -->
    state: absent
  register: remove_http_service_from_managed_zone
  when:
    - firewall_config_applied is defined
    - firewall_config_applied

- name: Reload firewalld to apply permanent configuration to runtime
  command: firewall-cmd --reload
  when:
    - firewall_running
    - restore_modified_zone_from_backup.changed
      or remove_http_service_from_managed_zone.changed