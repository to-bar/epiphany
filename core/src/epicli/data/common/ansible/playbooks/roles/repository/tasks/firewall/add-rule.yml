---
- name: Check if firewall rule for HTTP server exists
  command: firewall-cmd --query-service=http --zone={{ current_zone }}
  register: query_result
  changed_when: false
  failed_when: query_result.rc not in [0, 1] # 0 => rule exists

- name: Set query result as fact
  set_fact:
    firewall_rule_exists: "{{ true if query_result.rc == 0 else false }}"

- name: Add temporary firewall rule # if doesn't exists
  block:
    - name: Backup configuration file of current zone ({{ current_zone }})
      import_role:
        name: firewall
        tasks_from: backup-zone
      vars:
        zone_to_backup: "{{ current_zone }}"

    # Save zone in file containing list of temporarily modified zones to be restored
    - name: Add current zone to list of temporarily modified zones
      import_role:
        name: firewall
        tasks_from: update-modified-zones-list
      vars:
        modified_zone:
          name: "{{ current_zone }}"
          modified_by_role: repository
          backup_path: "{{ epiphany_tmp_persistent_dir }}/firewall/{{ current_zone }}.xml.bak"

    # This task is the last in block by purpose because of the block's when condition
    - name: Add temporary firewall rule for HTTP server
      shell: firewall-cmd --add-service=http --zone={{ current_zone }} --permanent &&
             firewall-cmd --add-service=http --zone={{ current_zone }}
  when:
    - not firewall_rule_exists